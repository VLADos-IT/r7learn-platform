name: Backup Resources and DB

on:
  schedule:
    - cron: '0 */3 * * *' # Every 3 hours
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: SSH Backup Script
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            BACKUP_DIR="/opt/r7l_backups"
            mkdir -p $BACKUP_DIR
            TIMESTAMP=$(date +"%F_%H-%M-%S")
            # Backup DB
            docker exec r7l-postgres pg_dump -U r7l_admin r7l > $BACKUP_DIR/db_backup_$TIMESTAMP.sql
            # Backup resources
            tar czf $BACKUP_DIR/resources_$TIMESTAMP.tar.gz ./resources/docx ./resources/exercise_desc ./resources/exercises ./resources/Tests
            # (Optional) Remove old backups, keep only the 7 most recent
            ls -tp $BACKUP_DIR/db_backup_*.sql | grep -v '/$' | tail -n +8 | xargs -r rm --
            ls -tp $BACKUP_DIR/resources_*.tar.gz | grep -v '/$' | tail -n +8 | xargs -r rm --